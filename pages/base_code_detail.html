<div class="container-fluid">

    <!-- Begin Page Header-->
    <div class="row">
        <div class="page-header">
            <div class="d-flex align-items-center">
                <h2 class="page-header-title">코드상세 관리</h2>
                <div>
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="index.html"><i class="la la-home"></i></a></li>
                        <li class="breadcrumb-item">코드 관리</li>
                        <li class="breadcrumb-item active">코드상세 관리</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- End Page Header -->

        <div class="col-sm-12">
            <div class="widget has-shadow">
                <div class="widget-body">

                    <div class="row">
                        <div class="col-sm-4">
                            <!-- 검색영역 끝-->
                            <div class="widget">
                                <div class="widget-body no-padding scroll-area">
                                    <table id="table" class="table table-bordered no-margin" summary="품목명 리스트">
                                        <thead>
                                            <tr>
                                                <th>대분류</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <div class="row">
                                                        <div class="col-sm-8">
                                                            <input type="text" class="form-control" placeholder="품목대분류1">
                                                        </div>
                                                        <div class="col-sm-4 d-flex justify-content-end">
                                                            <button type="button" class="btn btn-sm btn-secondary"><i class="la la-arrows-alt"></i></button>
                                                            <button type="button" class="btn btn-sm btn-secondary"><i class="la la-times"></i></button>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <div class="row">
                                                        <div class="col-sm-8">
                                                            <input type="text" class="form-control" placeholder="품목대분류2">
                                                        </div>
                                                        <div class="col-sm-4 d-flex justify-content-end">
                                                            <button type="button" class="btn btn-sm btn-secondary"><i class="la la-arrows-alt"></i></button>
                                                            <button type="button" class="btn btn-sm btn-secondary"><i class="la la-times"></i></button>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <div class="row">
                                                        <div class="col-sm-8">
                                                            <input type="text" class="form-control" placeholder="품목대분류3">
                                                        </div>
                                                        <div class="col-sm-4 d-flex justify-content-end">
                                                            <button type="button" class="btn btn-sm btn-secondary"><i class="la la-arrows-alt"></i></button>
                                                            <button type="button" class="btn btn-sm btn-secondary"><i class="la la-times"></i></button>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <div class="row">
                                                        <div class="col-sm-8">
                                                            <input type="text" class="form-control" placeholder="품목대분류4">
                                                        </div>
                                                        <div class="col-sm-4 d-flex justify-content-end">
                                                            <button type="button" class="btn btn-sm btn-secondary"><i class="la la-arrows-alt"></i></button>
                                                            <button type="button" class="btn btn-sm btn-secondary"><i class="la la-times"></i></button>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <div class="row">
                                                        <div class="col-sm-8">
                                                            <input type="text" class="form-control" placeholder="품목대분류5">
                                                        </div>
                                                        <div class="col-sm-4 d-flex justify-content-end">
                                                            <button type="button" class="btn btn-sm btn-secondary"><i class="la la-arrows-alt"></i></button>
                                                            <button type="button" class="btn btn-sm btn-secondary"><i class="la la-times"></i></button>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>

                                        </tbody>
                                    </table>
                                </div>

                                <div class="widget-footer">
                                    <div class="row">
                                        <div class="col-sm-8">
                                            <input type="text" class="form-control" placeholder="품목대분류1">
                                        </div>
                                        <div class="col-sm-4 d-flex justify-content-end">
                                            <button type="button" class="btn btn-block btn-sm btn-outline-primary">추가</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-sm-4">
                            <div class="widget">
                                <div class="widget-body no-padding scroll-area">
                                    <table id="item-selected-table" class="table table-bordered no-margin" summary="품목명 리스트">

                                        <thead>
                                            <tr>
                                                <th>중분류</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="4" class="default-state-table">
                                                    대분류를 먼저 선택해 주세요
                                                </td>
                                            </tr>

                                        </tbody>
                                    </table>

                                </div>

                                <div class="widget-footer">
                                    <div class="row">
                                        <div class="col-sm-8">
                                            <input type="text" class="form-control" placeholder="품목대분류1" disabled>
                                        </div>
                                        <div class="col-sm-4 d-flex justify-content-end">
                                            <button type="button" class="btn btn-block btn-sm btn-outline-primary" disabled>추가</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="col-sm-4">
                            <div class="widget">
                                <div class="widget-body no-padding scroll-area">
                                    <table id="item-selected-table" class="table table-bordered no-margin" summary="품목명 리스트">

                                        <thead>
                                            <tr>
                                                <th>소분류</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="4" class="default-state-table">
                                                    중분류를 먼저 선택해 주세요
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="widget-footer">
                                    <div class="row">
                                        <div class="col-sm-8">
                                            <input type="text" class="form-control" placeholder="품목대분류1" disabled>
                                        </div>
                                        <div class="col-sm-4 d-flex justify-content-end">
                                            <button type="button" class="btn btn-block btn-sm btn-outline-primary" disabled>추가</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <div class="widget-footer">
                    <div class="row">
                        <div class="col-sm-6 d-flex align-items-center justify-content-md-start">
                            <button type="button" class="btn btn-outline-primary">목록</button>
                        </div>
                        <div class="col-sm-6 d-flex align-items-center justify-content-md-end">
                            <button type="button" class="btn btn-primary">저장</button>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <!-- End Page Content -->
</div>
<style>
    .draggable {
        cursor: move;
        user-select: none;
    }
    
    .placeholder {
        background-color: #edf2f7;
        border: 2px dashed #cbd5e0;
    }
    
    .clone-table th {
        border: 1px solid #dee2e6;
        border-bottom: 2px solid #dee2e6;
        text-align: center;
        background: #f4f4f4;
        vertical-align: middle;
        padding: 10px;
        color: #5d5386;
    }
    
    .clone-table td {
        border: 1px solid #dee2e6;
        border-top: 0;
        padding: 3px 10px;
        vertical-align: middle;
        text-align: center;
    }
    
    .dragging {
        background: #fff;
        border-top: 1px solid #ccc;
        z-index: 999;
    }
</style>

<script>
    const table = document.getElementById('table');

    let draggingEle;
    let draggingRowIndex;
    let placeholder;
    let list;
    let isDraggingStarted = false;

    let x = 0;
    let y = 0;

    const swap = function(nodeA, nodeB) {
        const parentA = nodeA.parentNode;
        const siblingA = nodeA.nextSibling === nodeB ? nodeA : nodeA.nextSibling;
        nodeB.parentNode.insertBefore(nodeA, nodeB);

        parentA.insertBefore(nodeB, siblingA);
    };

    const isAbove = function(nodeA, nodeB) {
        const rectA = nodeA.getBoundingClientRect();
        const rectB = nodeB.getBoundingClientRect();

        return (rectA.top + rectA.height / 2 < rectB.top + rectB.height / 2);
    };

    const cloneTable = function() {
        const rect = table.getBoundingClientRect() / 2;
        const width = parseInt(window.getComputedStyle(table).width);

        list = document.createElement('div');
        list.classList.add('clone-list');
        list.style.position = 'absolute';
        list.style.left = `${rect.left}px`;
        list.style.top = `${rect.top}px`;
        table.parentNode.insertBefore(list, table);

        table.style.visibility = 'hidden';

        table.querySelectorAll('tr').forEach(function(row) {

            const item = document.createElement('div');
            item.classList.add('draggable');

            const newTable = document.createElement('table');
            newTable.setAttribute('class', 'clone-table');
            newTable.style.width = `${width}px`;

            const newRow = document.createElement('tr');
            const cells = [].slice.call(row.children);
            cells.forEach(function(cell) {
                const newCell = cell.cloneNode(true);
                newCell.style.width = `${parseInt(window.getComputedStyle(cell).width)}px`;
                newRow.appendChild(newCell);
            });

            newTable.appendChild(newRow);
            item.appendChild(newTable);
            list.appendChild(item);
        });
    };

    const mouseDownHandler = function(e) {
        const originalRow = e.target.closest('tr');

        draggingRowIndex = [].slice.call(table.querySelectorAll('tr')).indexOf(originalRow);

        x = e.clientX;
        y = e.clientY;

        document.addEventListener('mousemove', mouseMoveHandler);
        document.addEventListener('mouseup', mouseUpHandler);
    };

    const mouseMoveHandler = function(e) {
        if (!isDraggingStarted) {
            isDraggingStarted = true;

            cloneTable();

            draggingEle = [].slice.call(list.children)[draggingRowIndex];
            draggingEle.classList.add('dragging');

            placeholder = document.createElement('div');
            placeholder.classList.add('placeholder');
            draggingEle.parentNode.insertBefore(placeholder, draggingEle.nextSibling);
            placeholder.style.height = `${draggingEle.offsetHeight}px`;
        }

        draggingEle.style.position = 'absolute';
        draggingEle.style.top = `${draggingEle.offsetTop + e.clientY - y}px`;
        draggingEle.style.left = `${draggingEle.offsetLeft + e.clientX - x}px`;

        x = e.clientX;
        y = e.clientY;

        const prevEle = draggingEle.previousElementSibling;
        const nextEle = placeholder.nextElementSibling;

        if (prevEle && prevEle.previousElementSibling && isAbove(draggingEle, prevEle)) {

            swap(placeholder, draggingEle);
            swap(placeholder, prevEle);
            return;
        }

        if (nextEle && isAbove(nextEle, draggingEle)) {

            swap(nextEle, placeholder);
            swap(nextEle, draggingEle);
        }
    };

    const mouseUpHandler = function() {
        placeholder && placeholder.parentNode.removeChild(placeholder);

        draggingEle.classList.remove('dragging');
        draggingEle.style.removeProperty('top');
        draggingEle.style.removeProperty('left');
        draggingEle.style.removeProperty('position');

        const endRowIndex = [].slice.call(list.children).indexOf(draggingEle);

        isDraggingStarted = false;

        list.parentNode.removeChild(list);

        let rows = [].slice.call(table.querySelectorAll('tr'));
        draggingRowIndex > endRowIndex ?
            rows[endRowIndex].parentNode.insertBefore(rows[draggingRowIndex], rows[endRowIndex]) :
            rows[endRowIndex].parentNode.insertBefore(rows[draggingRowIndex], rows[endRowIndex].nextSibling);

        table.style.removeProperty('visibility');

        document.removeEventListener('mousemove', mouseMoveHandler);
        document.removeEventListener('mouseup', mouseUpHandler);
    };

    table.querySelectorAll('tr').forEach(function(row, index) {
        if (index === 0) {
            return;
        }

        const firstCell = row.firstElementChild;
        const moveBtn = firstCell.querySelector('.btn');
        moveBtn.classList.add('draggable');

        moveBtn.addEventListener('mousedown', mouseDownHandler);
    });
</script>